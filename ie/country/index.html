<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <script src="//402-ALY-118.mktoweb.com/js/forms2/js/forms2.min.js"></script>
    <form id="mktoForm_1308"></form>
    <script>
      MktoForms2.loadForm('//402-ALY-118.mktoweb.com', '402-ALY-118', 1308, function (form) {
        // Se usa para obtener programas, countries, provinces
        const API_BASE =
          'https://publish-p147864-e1510969.adobeaemcloud.com/content/dam/ieprogram/json';

        const countryPicklist = document.getElementById('ie_countryid');
        const provincePicklist = document.getElementById('ie_provinceregionid');

        MktoForms2.whenReady(function (form) {
          getCountries(countryPicklist);
          toggleVisibility(provincePicklist, false);

          filterPathways([
            '9cfdcfe7-e324-eb11-a813-000d3a2cbc56',
            '90e2dcf3-e324-eb11-a813-000d3a2cbc56',
          ]);

          // Listener para cuando se cambia el país
          countryPicklist.addEventListener('change', function () {
            const selectedCountry = this.value;

            if (selectedCountry) {
              getProvinces(provincePicklist, selectedCountry);
            } else {
              toggleVisibility(provincePicklist, false);
            }
          });
        });

        form.onSuccess(function (values, _) {
          // Saca los datos del submit del form
          const params = {
            country: values.ie_countryid,
            province: values.ie_provinceregionid,
            gender: values.ie_genderidentity,
            interestedIn: values.ie_interestedin,
            pathwayId: values.ie_pathwayid,
            stakeholderRole: values.ie_stakeholdersroleid,
          };

          // Agrega dinamicamente los query params validando si estan vacios o no
          const queryString = Object.entries(params)
            .filter(([_, v]) => v != null && v !== '')
            .map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`)
            .join('&');

          // Redirecciona al usuario a la thank you page
          window.location.href = `${THANK_YOU_PAGE}${queryString ? '?' + queryString : ''}`;
          return false;
        });

        /**
         * Filtra las opciones de un 'select' para mostrar solo aquellas cuyos valores
         * coinciden con los IDs proporcionados en el listado.
         * @param {Array<string>} allowedPathwayIds - Un array con los IDs de las opciones que se deben mostrar.
         * Si el array está vacío, se mostrarán todas las opciones.
         */
        function filterPathways(allowedPathwayIds = []) {
          // Obtiene el elemento select del DOM.
          const pathwayPicklist = document.getElementById('ie_pathwayid');

          // Si el elemento no existe, termina la ejecución para evitar errores.
          if (!pathwayPicklist) {
            return;
          }

          // Itera sobre cada <option> que ya existe dentro del select.
          for (const option of pathwayPicklist.options) {
            // Determina si la opción debe ser visible.
            // Una opción es visible si:
            // 1. El listado de IDs permitidos está vacío (mostrar todo).
            // 2. El valor de la opción está incluido en el listado de IDs permitidos.
            // 3. La opción no tiene valor (ej. el "Select..." inicial).
            const shouldBeVisible =
              allowedPathwayIds.length === 0 ||
              allowedPathwayIds.includes(option.value) ||
              option.value === '';

            // Modifica el estilo 'display' para mostrar u ocultar la opción.
            // Asignar '' restaura el display por defecto del navegador.
            option.style.display = shouldBeVisible ? '' : 'none';
          }

          // Restablece la selección al valor por defecto para evitar
          // que una opción oculta permanezca seleccionada.
          pathwayPicklist.value = '';
        }

        /**
         * Fetch and populate countries into the country picklist.
         * @param {HTMLSelectElement} picklist - The country select element. Not the Id, the element itself.
         */
        function getCountries() {
          const picklist = document.getElementById('ie_countryid');

          fetch(`${API_BASE}/Country.json`)
            .then((response) => response.json())
            .then(({ entities: countries }) => {
              updatePicklist(picklist, countries);
            })
            .catch((error) => console.error('Error fetching countries:', error));
        }

        /**
         * Fetch and populate provinces based on the selected country.
         * @param {HTMLSelectElement} picklist - The province select element.
         * @param {string} country - The selected country ID.
         */
        function getProvinces() {
          const picklist = document.getElementById('ie_provinceregionid');
          const selectedCountry = document.getElementById('ie_countryid').value;

          fetch(`${API_BASE}/Province.json`)
            .then((response) => response.json())
            .then(({ entities: allProvinces }) => {
              const filteredProvinces = allProvinces.filter((province) =>
                province.attributes.some(
                  (attr) => attr.name === 'ie_countryid' && attr.value === selectedCountry
                )
              );

              // Controlamos la visibilidad del picklist
              toggleVisibility(picklist, filteredProvinces.length > 0);

              if (filteredProvinces.length > 0) {
                updatePicklist(picklist, filteredProvinces);
              }
            })
            .catch((error) => {
              console.error('Error fetching provinces:', error);
              toggleVisibility(picklist, false);
            });
        }

        /**
         * Muestra u oculta el campo según si es requerido o no.
         * @param {HTMLSelectElement} selectElement - El elemento select.
         * @param {boolean} isRequired - Indica si el campo debe ser visible (requerido) o no.
         */
        function toggleVisibility(element, isRequired) {
          // Encuentra el div padre que contiene la fila del formulario completa
          const formRow = element.closest('.mktoFormRow');

          if (isRequired) {
            formRow.style.display = 'block';
          } else {
            formRow.style.display = 'none';

            // Si el element es de tipo select, se limpian las opciones y se deja por defect una con value 000
            // Para evitar el error de campo requerido. Si es de otro tipo, se limpia su valor.
            if (element.tagName.toLowerCase() === 'select') {
              element.innerHTML = '<option value="000"></option>';
              element.value = '';
            } else {
              element.value = '';
            }
          }
        }

        /**
         * Update a picklist with new options.
         * @param {HTMLSelectElement} picklist - The select element to update.
         * @param {Array} items - The items to populate the picklist with.
         */
        function updatePicklist(picklist, items) {
          picklist.innerHTML = '<option value="">Select...</option>';

          items.forEach((item) => {
            const id = item.id.replace(/[{}]/g, '');
            const name =
              item.attributes.find((attr) => attr.name === 'ie_name')?.value || 'Unknown';

            const option = document.createElement('option');
            option.value = id;
            option.textContent = name;
            picklist.appendChild(option);
          });
        }
      });
    </script>
  </body>
</html>
