    <script>
        function setFormFieldCookies(fieldsObj, opts) {
            opts = opts || {};
            var days = (typeof opts.days === 'number') ? opts.days : undefined; // sesión si no se indica
            var includeEmpty = (opts.includeEmpty !== false); // por defecto guarda vacíos
            var whitelist = opts.whitelist; // opcional: array de claves a permitir

            for (var key in fieldsObj) {
                if (!fieldsObj.hasOwnProperty(key)) continue;
                if (whitelist && whitelist.indexOf(key) === -1) continue;

                var val = fieldsObj[key];
                if (!includeEmpty && (val == null || val === '')) continue;

                setCookie(key, (val == null ? '' : String(val)), days);
            }
        }
    </script>

    <script>
        (function () {
            var attempts = 0;
            var maxAttempts = 8;

            var checkExist = setInterval(function () {
                attempts++;

                if (typeof MktoForms2 !== 'undefined') {
                    clearInterval(checkExist);

                    MktoForms2.whenReady(function (form) {
                        console.log('cookiesDebugger: ready');

                        var emailInputs = document.querySelectorAll('input[name="Email"]');

                        // Variable para saber si encontramos alguno en esta vuelta
                        var foundAny = emailInputs.length > 0;

                        if (foundAny) {
                            // 2. Iteramos sobre cada input encontrado
                            emailInputs.forEach(function (emailInput) {

                                // 3. Verificamos individualmente si este input ya tiene el listener
                                if (!emailInput.dataset.ieUserIdListenerAttached) {
                                    console.log('cookiesDebugges', 'listener attached');

                                    // Marcamos este input específico como "listo"
                                    emailInput.dataset.ieUserIdListenerAttached = "true";

                                    // Agregamos el evento
                                    emailInput.addEventListener('change', function (event) {
                                        console.log('cookiesDebugger', 'change event fired');


                                        var value = event && event.target ? event.target.value : '';
                                        if (!value) return;

                                        // Validación funciones
                                        if (typeof MD5 === 'function' && typeof setCookie === 'function') {
                                            console.log('cookiesDebugger', 'setting cookie ie_user_userId');
                                            // Calculamos y guardamos la cookie
                                            setCookie('ie_user_userId', MD5(value));
                                            // Se guarda la cookie
                                            var values = {
                                                consentgroup: getCookie('cbgr'),
                                                consentId: getCookie('cbcid'),
                                                ie_hashuserid: getCookie('ie_user_userId'),
                                                uTMTracking: getCookie('ie_msc'),
                                                urlorigen: getCookie('nav_previous_page')
                                            };
                                            form.setValues(values);
                                            console.log('cookiesDebugger', 'form values set', values);
                                        }
                                    });
                                }
                            });
                        }

                        // 4. Lógica de reintento
                        // Si NO encontramos inputs, reintentamos rápido (cada 200ms) esperando a Marketo.
                        if (!foundAny) {
                            setTimeout(waitForEmailField, 200);
                        }
                    });
                } else if (attempts >= maxAttempts) {
                    clearInterval(checkExist);
                }
            }, 100);
        })();
    </script>

    <script type="text/javascript">
        var pollFormElementsIntervalId;

        function pollFormElements() {
            var forms = document.querySelectorAll("form[id^='mktoForm_'], form.mktoForm, form[data-formid]");
            if (forms instanceof NodeList && forms.length) {
                clearInterval(pollFormElementsIntervalId);
                forms.forEach(attachEventListener);
            }
        }

        function attachEventListener(form) {
            form.addEventListener("submit", function (evt) {
                // Wait for validations
                setTimeout(function () {
                    var isValid = form.querySelectorAll(".mktoInvalid").length === 0;
                    if (!isValid) return;

                    // Extract form fields by name
                    var getValue = function (name) {
                        var el = form.querySelector("[name='" + name + "']");
                        return el ? el.value : undefined;
                    };

                    // dataLayer variables preparation
                    var formFields = {
                        ie_form_formId: form.id || (form.dataset && form.dataset.formid) || (form.getAttribute && form.getAttribute('data-formid')) || (form.querySelector("[name='formid']") ? form.querySelector("[name='formid']").value : "") || "",
                        ie_form_formName: form.getAttribute("Name") || (form.dataset && (form.dataset.formname || form.dataset.formid)) || (form.querySelector("[name='formid']") ? form.querySelector("[name='formid']").value : "") || "",
                        ie_form_formType: getValue("mktoFormtype") || "",
                        ie_program_interestedIn: getValue("ie_interestedin") || "",
                        ie_program_pathwayId: getValue("ie_pathwayid") || "",
                        ie_program_pathwayName: IE_crmProgramPathwayMapper(getValue("ie_programmarketoid")) || IE_crmPathwayMapper(getValue("ie_pathwayid")) || IE_crmProgramPathwayMapperByName(getValue("ie_programmarketoid")) || "",
                        ie_program_programId: getValue("ie_programmarketoid") || "",
                        ie_program_programName: IE_crmProgramNameMapper(getValue("ie_programmarketoid")) || "",
                        ie_program_programCode: IE_crmProgramCodeMapper(getValue("ie_programmarketoid")) || IE_crmProgramCodeMapperByName(getValue("ie_programmarketoid")) || "",
                        ie_program_programType: IE_crmProgramTypeMapper(getValue("ie_programmarketoid")) || IE_crmProgramTypeMapperByName(getValue("ie_programmarketoid")) || "",
                        ie_program_programSchool: IE_crmProgramSchoolMapper(getValue("ie_programmarketoid")) || IE_crmProgramSchoolMapperByName(getValue("ie_programmarketoid")) || "",
                        ie_program_programUnit: IE_crmProgramUnitMapper(getValue("ie_programmarketoid")) || IE_crmProgramUnitMapperByName(getValue("ie_programmarketoid")) || "",
                        ie_program_tracks: getValue("tracks") || "",
                        ie_program_typeofDualMastersdegrees: getValue("typeofDualMastersdegrees") || "",
                        ie_program_mktoSummerSpecialization: getValue("mktoSummerSpecialization") || "",
                        ie_geo_countryId: getValue("ie_countryid") || "",
                        ie_geo_country: IE_crmCountryMapper(getValue("ie_countryid")) || "",
                        ie_geo_worldRegion: IE_crmWorldRegionMapper(getValue("ie_countryid")) || "",
                        ie_geo_provinceRegionid: getValue("ie_provinceregionid") || "",
                        ie_geo_provinceRegion: IE_crmProvinceRegionMapper(getValue("ie_provinceregionid")) || "",
                        ie_user_firstName: getValue("FirstName") || "",
                        ie_user_lastName: getValue("MiddleName") || "",
                        ie_user_email: getValue("Email") || "", //
                        ie_user_userId: MD5(getValue("Email")) || "",
                        ie_user_gender: getValue("ie_genderidentity") || "",
                        ie_user_phoneCountryCode: getValue("phoneCountryCode") || "",
                        ie_user_phone: getValue("phone") || "",
                        ie_user_mktoStakeholder: getValue("mktoStakeholder") || "",
                        ie_user_estimateddateofadmissiontoie: getValue("ie_estimateddateofadmissiontoie") || "",
                        ie_user_yearsofexperience: getValue("ie_yearsofexperience") || "",
                        ie_user_linkedinprofileurl: getValue("ie_linkedinprofileurl") || "",
                        ie_user_preferredFormat: getValue("mktoPreferredFormat") || "",
                        ie_user_highschool: getValue("ie_highschool") || "",
                        ie_user_university: getValue("ie_university") || "",
                        ie_user_company: getValue("ie_company") || "",
                        ie_user_currentposition: getValue("ie_currentposition") || "",
                        ie_user_professionalsector: getValue("professionalsector") || "",
                        ie_user_mktoLanguage: getValue("mktoLanguage") || ""
                    };

                    // set variables as session cookies
                    setFormFieldCookies(formFields);

                    // event preparation
                    var payload = {
                        event: "marketo_form_submission",
                        formID: form.id, // form_formId
                        formName: form.getAttribute("Name") || form.id, // form_formName
                        formFields: formFields
                    };

                    // Ensure there is a dataLayer
                    window.dataLayer = window.dataLayer || [];
                    window.dataLayer.push(payload);
                }, 200); // Adjust it for more time if necessary
            });
        }

        // Launch polling each 0,5 secs
        pollFormElementsIntervalId = setInterval(pollFormElements, 500);
    </script>