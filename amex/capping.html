<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Capping test</title>

    <script
      src="https://assets.adobedtm.com/dcb19cbd6cbf/0a7da462a3cb/launch-d5b5108459af-development.min.js"
      async
    ></script>
  </head>
  <body>
    <button onclick="getSurface()">Send request</button>
    <button onclick="sendImpressions()">Send Impressions</button>

    <script>
      let ecid = ''; // Replace with actual ECID if needed
      let surface = '';
      let offerId = '';
      let activityId = '';
      let trackingToken = '';
      let eventToken = '';
      let correlationId = '';

      let bearerToken = '';

      // on page load
      window.onload = () => {
        console.log('Page loaded');
      };

      const getBearerToken = () => {
        const myHeaders = new Headers();
        myHeaders.append('Content-Type', 'application/x-www-form-urlencoded');
        myHeaders.append('Cookie', 'ftrset=858; relay=6074a057-7f1d-4cd9-bb1c-aaea1f515c72');

        const urlencoded = new URLSearchParams();
        urlencoded.append('grant_type', 'client_credentials');
        urlencoded.append('client_id', '22f5891fe35f426e946e5a35fa71a8ca');
        urlencoded.append('client_secret', 'p8e-d7ItxRX1tzcd3AfgaODA2AEHDST5Lm6X');
        urlencoded.append(
          'scope',
          'cjm.suppression_service.client.delete,cjm.suppression_service.client.all,openid,session,AdobeID,read_organizations,additional_info.projectedProductContext'
        );

        const requestOptions = {
          method: 'POST',
          headers: myHeaders,
          body: urlencoded,
          redirect: 'follow',
        };

        fetch('https://ims-na1.adobelogin.com/ims/token/v3', requestOptions)
          .then((response) => response.text())
          .then((result) => {
            const obj = JSON.parse(result);
            bearerToken = obj.access_token;
            console.log('Bearer Token:', bearerToken);
          })
          .catch((error) => console.error(error));
      };

      const getSurface = () => {
        const myHeaders = new Headers();
        myHeaders.append('x-gw-ims-org-id', '5C36123F5245AF470A490D45@AdobeOrg');
        myHeaders.append('x-api-key', '22f5891fe35f426e946e5a35fa71a8ca');
        myHeaders.append('Content-Type', 'application/json');
        myHeaders.append('Authorization', 'Bearer ' + bearerToken);

        const raw = JSON.stringify({
          event: {
            xdm: {
              _id: '4668d917-550f-4b9d-b046-b0326b392b20',
              timestamp: '2025-12-04T01:14:24.984Z',
              identityMap: {
                ECID: [
                  {
                    id: '69746950276683044038191108951084155569',
                    primary: true,
                  },
                ],
              },
              eventType: 'decisioning.propositionFetch',
            },
          },
          query: {
            personalization: {
              schemas: [
                'https://ns.adobe.com/personalization/default-content-item',
                'https://ns.adobe.com/personalization/html-content-item',
                'https://ns.adobe.com/personalization/json-content-item',
                'https://ns.adobe.com/personalization/redirect-item',
                'https://ns.adobe.com/personalization/dom-action',
              ],
              surfaces: ['web://localhost#cappingTest'],
            },
          },
        });

        const requestOptions = {
          method: 'POST',
          headers: myHeaders,
          body: raw,
          redirect: 'follow',
          mode: 'cors',
          credentials: 'include',
        };

        fetch(
          'https://server.adobedc.net/ee/v2/interact?datastreamId=15fdfe3d-17b7-4133-a832-01fd7a5c2112',
          requestOptions
        )
          .then((response) => response.text())
          .then((result) => console.log(result))
          .catch((error) => console.error(error));
      };

      const generateUUID = () => {
        // Simple UUID generator
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
          const r = (Math.random() * 16) | 0,
            v = c === 'x' ? r : (r & 0x3) | 0x8;
          return v.toString(16);
        });
      };

      const sendImpressions = () => {
        alloy('sendEvent', {
          edgeConfigOverrides: { datastreamId: '15fdfe3d-17b7-4133-a832-01fd7a5c2112' },
          xdm: {
            _id: generateUUID(),
            timestamp: new Date().toISOString(),
            eventType: 'decisioning.propositionDisplay',
            identityMap: {
              ECID: [
                {
                  id: ecid,
                  authenticatedState: 'authenticated',
                  primary: true,
                },
              ],
            },
            _experience: {
              decisioning: {
                propositionEventType: {
                  display: 1,
                },
                propositionAction: {
                  id: offerId,
                  tokens: [trackingToken],
                },
                propositions: [
                  {
                    id: offerId,
                    scope: surface,
                    scopeDetails: {
                      characteristics: {
                        eventToken: eventToken, // Attribution token
                      },
                      activity: {
                        id: activityId, // Activity ID
                        matchedSurfaces: [surface], // Surfaces where the offer was shown
                      },
                      correlationID: correlationId, // Links to previous events
                      decisionProvider: 'AJO', // Indicates AJO made the decision
                    },
                  },
                ],
              },
            },
          },
        });
      };
    </script>
  </body>
</html>
