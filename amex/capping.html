<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Capping test</title>

    <script
      src="https://assets.adobedtm.com/dcb19cbd6cbf/0a7da462a3cb/launch-d5b5108459af-development.min.js"
      async
    ></script>
  </head>
  <body>
    <div
      style="display: flex; flex-direction: column; gap: 8px; max-width: 350px; margin-bottom: 30px"
    >
      <label for="ecidInput">ECID</label>
      <input type="text" id="ecidInput" placeholder="Enter ECID" />

      <label for="surfaceInput">Surface</label>
      <input type="text" id="surfaceInput" placeholder="Enter Surface" />

      <label for="offerIdInput">Offer ID</label>
      <input type="text" id="offerIdInput" placeholder="Enter Offer ID" />

      <label for="activityIdInput">Activity ID</label>
      <input type="text" id="activityIdInput" placeholder="Enter Activity ID" />

      <label for="trackingTokenInput">Tracking Token</label>
      <input type="text" id="trackingTokenInput" placeholder="Enter Tracking Token" />

      <label for="correlationIdInput">Correlation ID</label>
      <input type="text" id="correlationIdInput" placeholder="Enter Correlation ID" />

      <label for="eventTokenInput">Event Token</label>
      <input type="text" id="eventTokenInput" placeholder="Enter Event Token" />
    </div>

    <!-- <button onclick="getSurface()">Send request</button> -->
    <button onclick="sendImpressions()">Send Impressions</button>

    <script>
      window.onload = () => {
        document.getElementById('ecidInput').value = '69746950276683044038191108951084155569';
        document.getElementById('surfaceInput').value = 'web://localhost#cappingTest2';
        document.getElementById('offerIdInput').value =
          'dps:c03eb4695e382ccb3e3f87ca2940a4003ab72a68251f640c:1bb4a21e9177a4cb';
        document.getElementById('activityIdInput').value =
          '27b2cd6c-d46e-4e88-bc56-d50a059ff451#fbd8162c-3240-49cf-aff9-96931f2ea4d8';
        document.getElementById('trackingTokenInput').value = '';
        document.getElementById('eventTokenInput').value = '';
        document.getElementById('correlationIdInput').value =
          '4bbf04bf-cc0f-4be2-a0ca-f00c9e261c55-0';
      };

      const generateUUID = () => {
        // Simple UUID generator
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
          const r = (Math.random() * 16) | 0,
            v = c === 'x' ? r : (r & 0x3) | 0x8;
          return v.toString(16);
        });
      };

      const sendImpressions = () => {
        // üìù DECLARACI√ìN DE VARIABLES (Valores de los Inputs)
        const ecidValue = document.getElementById('ecidInput').value;
        const offerIdValue = document.getElementById('offerIdInput').value;
        const trackingTokenValue =
          document.getElementById('trackingTokenInput').value || 'KFlnpIR6kVibhtAQru7CUw';
        const surfaceValue = document.getElementById('surfaceInput').value;
        const eventTokenValue =
          document.getElementById('eventTokenInput').value ||
          'eyJtZXNzYWdlRXhlY3V0aW9uIjp7Im1lc3NhZ2VFeGVjdXRpb25JRCI6IlVFOkluYm91bmQiLCJtZXNzYWdlSUQiOiIzZTMyNjU0YS0xZmNiLTRiNWMtYmYxNy1hZjU3Mjk4Y2M1YzYiLCJtZXNzYWdlUHVibGljYXRpb25JRCI6ImIwYmU5MTEyLWY0MjItNDk1OC1iZTMzLTQ2NDNmZDNlZjc3NyIsIm1lc3NhZ2VUeXBlIjoibWFya2V0aW5nIiwiY2FtcGFpZ25JRCI6IjZjMmIyYjgwLThlZTItNDc3YS05ZmE5LWIyNDY0NTk2ZmE5ZSIsImNhbXBhaWduVmVyc2lvbklEIjoiN2YxYWE3MTUtMjJjMy00MzFkLWFiMzctNTlkNTRmMzNjMWJjIiwiY2FtcGFpZ25BY3Rpb25JRCI6IjBjMjcxZTE0LWQ4MDYtNDQwMC05NmVmLTQ0N2JkNTA3MzMyZCJ9LCJtZXNzYWdlUHJvZmlsZSI6eyJtZXNzYWdlUHJvZmlsZUlEIjoiZDY3MzM2ZjgtYmM4NC00YjM4LWI5OWUtNzBjNTMwZjBhM2Q4IiwiY2hhbm5lbCI6eyJfaWQiOiJodHRwczovL25zLmFkb2JlLmNvbS94ZG0vY2hhbm5lbHMvY29kZSIsIl90eXBlIjoiaHR0cHM6Ly9ucy5hZG9iZS5jb20veGRtL2NoYW5uZWwtdHlwZXMvY29kZSJ9fX0=';
        const activityIdValue = document.getElementById('activityIdInput').value;
        const correlationIdValue = document.getElementById('correlationIdInput').value;

        // üí° Otras Variables de Soporte
        const datastreamId = '15fdfe3d-17b7-4133-a832-01fd7a5c2112';
        const decisionProvider = 'AJO';

        alloy('sendEvent', {
          personalization: {
            decisionsScopes: [surfaceValue],
            surfaces: [surfaceValue],
            schemas: [
              'https://ns.adobe.com/personalization/default-content-item',
              'https://ns.adobe.com/personalization/html-content-item',
              'https://ns.adobe.com/personalization/json-content-item',
              'https://ns.adobe.com/personalization/redirect-item',
              'https://ns.adobe.com/personalization/dom-action',
            ],
            defaultPersonalizationEnabled: false,
          },
          edgeConfigOverrides: { datastreamId: datastreamId },
          xdm: {
            _id: generateUUID(),
            timestamp: new Date().toISOString(),
            eventType: 'decisioning.propositionInteract',
            identityMap: {
              ECID: [
                {
                  // Usamos la variable declarada
                  id: ecidValue,
                  authenticatedState: 'authenticated',
                  primary: true,
                },
              ],
            },
            _experience: {
              decisioning: {
                propositionEventType: {
                  interact: 1,
                },
                propositionAction: {
                  // Usamos las variables declaradas
                  id: offerIdValue,
                  tokens: [trackingTokenValue],
                },
                propositions: [
                  {
                    // Usamos las variables declaradas
                    id: offerIdValue,
                    scope: surfaceValue,
                    scopeDetails: {
                      characteristics: {
                        // Usamos la variable declarada
                        eventToken: eventTokenValue, // Attribution token
                      },
                      activity: {
                        // Usamos las variables declaradas
                        id: activityIdValue, // Activity ID
                        matchedSurfaces: [surfaceValue], // Surfaces where the offer was shown
                      },
                      // Usamos la variable declarada
                      correlationID: correlationIdValue, // Links to previous events
                      decisionProvider: decisionProvider, // Indicates AJO made the decision
                    },
                  },
                ],
              },
            },
          },
        });

        // reset event and tracking token
      };
    </script>
  </body>
</html>
