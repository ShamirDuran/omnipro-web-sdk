<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Marketo Form</title>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        display: flex;
        height: 100vh;
        justify-content: center;
        align-items: center;
      }
    </style>

    <script type="text/javascript">
      (function () {
        var didInit = false;
        function initMunchkin() {
          if (didInit === false) {
            didInit = true;
            Munchkin.init('402-ALY-118');
            // Munchkin.createTrackingCookie(true);
          }
        }
        var s = document.createElement('script');
        s.type = 'text/javascript';
        s.async = true;
        s.src = '//munchkin.marketo.net/munchkin.js';
        s.onreadystatechange = function () {
          if (this.readyState == 'complete' || this.readyState == 'loaded') {
            initMunchkin();
          }
        };
        s.onload = initMunchkin;
        document.getElementsByTagName('head')[0].appendChild(s);
      })();
    </script>
  </head>

  <body>
    <script src="//152-ZQW-300.mktoweb.com/js/forms2/js/forms2.min.js"></script>
    <form id="mktoForm_1046"></form>

    <script src="//402-ALY-118.mktoweb.com/js/forms2/js/forms2.min.js"></script>
    <form id="mktoForm_1002"></form>

    <a href="#">Test Link </a>
    <button id="submitButton" type="button">Submit View</button>
    <button id="submitButton2" type="button">Submit Link</button>

    <script>
      MktoForms2.loadForm('//402-ALY-118.mktoweb.com', '402-ALY-118', 1002, function (form) {
        const interestedIn = document.querySelector('#ie_interestedin');

        // Obtencion de programas desde cache AEM
        const getPrograms = () => {
          const programPicklist = document.querySelector('#mkto_programoriginal');

          fetch(
            'https://publish-p147864-e1510969.adobeaemcloud.com/content/dam/ieprogram/json/programas.json',
            {
              method: 'GET',
              redirect: 'follow',
            }
          )
            .then((response) => response.json())
            .then(({ value: programs }) => {
              // filter programs.parentprogramid.productid for this value 1fdcc153-9ef1-df11-bc9f-005056b460d2
              const filteredPrograms = programs
                .filter(
                  (program) =>
                    program.parentproductid.productid === '1fdcc153-9ef1-df11-bc9f-005056b460d2'
                )
                .slice(0, 10); // Limit to 10

              // clear existing options in the programPicklist
              programPicklist.innerHTML = '';

              console.log(filteredPrograms);

              // Populate the programPicklist with the filtered programs
              filteredPrograms.forEach((program) => {
                const option = document.createElement('option');
                option.value = program.productid;
                option.textContent = program.name;

                programPicklist.appendChild(option);
              });
            })
            .catch((error) => console.error(error));
        };

        // Observa cambios en el DOM
        let wasProgramPicklistPresent = false;

        const observer = new MutationObserver(() => {
          console.log('entro al observer');

          const programPicklist = document.querySelector('#mkto_programoriginal');
          if (programPicklist && !wasProgramPicklistPresent) {
            console.log('primer if observer');

            // Element just appeared
            wasProgramPicklistPresent = true;
            getPrograms();
          }

          if (!programPicklist && wasProgramPicklistPresent) {
            console.log('segundo if observer');

            // Element was removed
            wasProgramPicklistPresent = false;
          }
        });

        observer.observe(document.body, {
          childList: true,
          subtree: true,
        });

        form.onSuccess(function (values, followUpUrl) {
          console.log('Form submitted successfully:', values);
          return false; // Prevent default form submission
        });
      });

      // on click
      document.getElementById('submitButton').addEventListener('click', function () {
        alert('Visit Page!');

        Munchkin.munchkinFunction('visitWebPage', {
          url: '/test/page/viewed.html',
          params: 'leadId=' + 'testLeadId',
        });
      });

      document.getElementById('submitButton2').addEventListener('click', function () {
        alert('Clicked!');

        Munchkin.munchkinFunction('clickLink', {
          href: '/test/clicked/link.html',
        });
      });
    </script>
  </body>
</html>
