<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Reporte de Horas Extra</title>
    <!-- Tailwind CSS para estilos rápidos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Librerías para CSV y Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Fuente -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-lg border border-gray-100">
        <div class="text-center mb-8">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">Reporte de Horas Extra</h1>
            <p class="text-gray-500 text-sm">Sube tu archivo <code class="bg-gray-100 px-1 rounded">report.csv</code> para procesar.</p>
        </div>

        <!-- Área de Carga -->
        <div id="drop-area" class="border-2 border-dashed border-blue-300 rounded-xl p-8 text-center bg-blue-50 hover:bg-blue-100 transition cursor-pointer relative">
            <input type="file" id="fileInput" accept=".csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
            <div class="space-y-2 pointer-events-none">
                <svg class="w-10 h-10 mx-auto text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                <p class="text-blue-600 font-medium">Haz clic o arrastra tu CSV aquí</p>
                <p class="text-xs text-blue-400">Formato delimitado por punto y coma (;)</p>
            </div>
        </div>

        <!-- Estado y Resultados -->
        <div id="statusArea" class="mt-6 hidden">
            <div class="flex items-center justify-between p-4 bg-green-50 text-green-700 rounded-lg border border-green-200">
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span id="statusText" class="font-medium text-sm">Procesado con éxito</span>
                </div>
                <span id="rowCount" class="text-xs bg-green-200 px-2 py-1 rounded-full text-green-800 font-bold">0 filas</span>
            </div>
            
            <button id="downloadBtn" class="w-full mt-4 bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 px-4 rounded-lg shadow transition transform active:scale-95 flex justify-center items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                Descargar Excel
            </button>
        </div>

        <div id="errorArea" class="mt-6 hidden p-4 bg-red-50 text-red-700 rounded-lg border border-red-200 text-sm"></div>

        <div class="mt-8 pt-6 border-t border-gray-100 text-xs text-gray-400 text-center">
            Regla de negocio: Jornada 8:00 AM - 6:00 PM
        </div>
    </div>

    <script>
        // Configuración
        const WORK_START_HOUR = 8; // 8 AM
        const WORK_END_HOUR = 18;  // 6 PM (18:00)

        const fileInput = document.getElementById('fileInput');
        const statusArea = document.getElementById('statusArea');
        const errorArea = document.getElementById('errorArea');
        const statusText = document.getElementById('statusText');
        const rowCountBadge = document.getElementById('rowCount');
        const downloadBtn = document.getElementById('downloadBtn');

        let processedData = [];

        fileInput.addEventListener('change', handleFile);

        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            resetUI();

            // Usar PapaParse para leer el CSV
            Papa.parse(file, {
                header: true,
                delimiter: ";", // Importante para tu formato regional
                skipEmptyLines: true,
                encoding: "UTF-8", // Intentamos UTF-8 primero
                complete: function(results) {
                    try {
                        if (results.errors.length > 0) {
                            console.warn("Advertencias de CSV:", results.errors);
                        }
                        processData(results.data);
                    } catch (err) {
                        showError("Error procesando datos: " + err.message);
                    }
                },
                error: function(err) {
                    showError("Error leyendo el archivo: " + err.message);
                }
            });
        }

        function processData(rows) {
            processedData = [];

            rows.forEach((row, index) => {
                // Mapeo seguro de columnas (limpieza de espacios en nombres de columna por si acaso)
                // Buscamos las claves ignorando mayúsculas/minúsculas exactas si es necesario, 
                // pero asumiremos los nombres que diste.
                
                const fechaStr = (row['Fecha'] || '').trim();
                const horaInicioStr = (row['Hora Registro'] || '').trim();
                const horaFinStr = (row['Hasta'] || '').trim();
                
                if (!fechaStr || !horaInicioStr || !horaFinStr) return; // Saltar filas vacías o corruptas

                try {
                    // Crear fechas de Javascript
                    // Asumimos formato YYYY-MM-DD para fecha y HH:MM para horas
                    const startDateTime = parseDateTime(fechaStr, horaInicioStr);
                    let endDateTime = parseDateTime(fechaStr, horaFinStr);

                    // Ajuste si cruza la medianoche (termina al día siguiente)
                    if (endDateTime < startDateTime) {
                        endDateTime.setDate(endDateTime.getDate() + 1);
                    }

                    // Definir límites de jornada para ESE día específico
                    const shiftStart = new Date(startDateTime);
                    shiftStart.setHours(WORK_START_HOUR, 0, 0, 0);

                    const shiftEnd = new Date(startDateTime);
                    shiftEnd.setHours(WORK_END_HOUR, 0, 0, 0);

                    // Datos descriptivos
                    const cliente = row['Cliente'] || 'N/A';
                    let resumen = (row['Resumen de incidencia'] || '').trim();
                    let descripcion = (row['Descripción del Trabajo'] || '').trim();
                    // Limpieza de texto para excel
                    descripcion = descripcion.replace(/[\r\n]+/g, ' '); 
                    const trabajoRealizado = `${resumen} - ${descripcion}`;

                    // --- LÓGICA DE HORAS EXTRA (Igual que en Python) ---

                    // CASO 1: Antes de jornada (Antes de las 8am)
                    if (startDateTime < shiftStart) {
                        const otStart = startDateTime;
                        // Fin es el menor entre: fin de tarea o inicio jornada
                        const otEnd = new Date(Math.min(endDateTime, shiftStart));

                        if (otEnd > otStart) {
                            addOvertimeRow(otStart, otEnd, cliente, `[EXTRA AM] ${trabajoRealizado}`);
                        }
                    }

                    // CASO 2: Después de jornada (Después de las 6pm)
                    if (endDateTime > shiftEnd) {
                        // Inicio es el mayor entre: inicio tarea o fin jornada
                        const otStart = new Date(Math.max(startDateTime, shiftEnd));
                        const otEnd = endDateTime;

                        if (otEnd > otStart) {
                            addOvertimeRow(otStart, otEnd, cliente, `[EXTRA PM] ${trabajoRealizado}`);
                        }
                    }

                } catch (e) {
                    console.error(`Error en fila ${index}:`, e);
                }
            });

            if (processedData.length > 0) {
                // Ordenar por fecha y hora
                processedData.sort((a, b) => {
                    const dateA = new Date(`${a.Fecha} ${a['Hora (Desde)']}`);
                    const dateB = new Date(`${b.Fecha} ${b['Hora (Desde)']}`);
                    return dateA - dateB;
                });

                showSuccess(processedData.length);
            } else {
                showError("No se encontraron horas extras con los criterios (Antes 8am / Después 6pm).");
            }
        }

        function addOvertimeRow(start, end, cliente, trabajo) {
            // Formatear Día
            const days = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
            const dayName = days[start.getDay()];

            processedData.push({
                'Fecha': formatDate(start),
                'Dia': dayName,
                'Hora (Desde)': formatTime(start),
                'Hora (Hasta)': formatTime(end),
                'Cliente': cliente,
                'Trabajo realizado': trabajo
            });
        }

        // Helpers